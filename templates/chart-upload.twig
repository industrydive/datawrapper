{% extends "chart-editor.twig" %}

{% block content %}

{{ parent() }}

<div class="dw-create-upload">

    <script type="text/javascript">

        $(function() {

            function init() {

            }

            function nextPage(url) {
                location.href = url;
            }

            function uploadData(url) {
                DW.currentChart.set('metadata.data.source', 'clipboard');
                $.ajax({
                    url: '/api/charts/' + DW.currentChart.get('id') + '/data',
                    type: 'PUT',
                    data: $('#upload-data-text').val(),
                    processData: false,
                    dataType: 'json',
                    success: function(result) {
                        if (result.status == "ok") {
                            // data is saved correctly, so proceed
                            nextPage(url);
                        } else {
                            alert(result.message);
                        }
                    }
                });
                return false;
            }

            $('#upload-data').click(function() {
                uploadData('describe');
            });

            var txtarea = $('#upload-data-text');


            new qq.FileUploader({
                element: $('#upload')[0],
                action: '/api/charts/' + DW.currentChart.get('id') + '/data',
                allowedExtensions: ['txt', 'csv', 'tsv'],
                template: '<div class="upload-drop">{% trans "drop your csv file here" %}</div><div class="btn upload-button" id="pick-file-from-disk"><span><i class="icon-upload"></i> {% trans "..or upload a CSV file" %}</span></div><ul class="qq-upload-list" style="display:none"></ul>',
                classes: {
                    button: 'upload-button',
                    drop: 'upload-drop',
                    dropActive: 'upload-drop-active',
                    list: 'qq-upload-list',
                    file: 'qq-upload-file',
                    spinner: 'qq-upload-spinner',
                    size: 'qq-upload-size',
                    cancel: 'qq-upload-cancel'
                },
                multiple: false,
                onComplete: function(code, filename, res) {
                    if (res.status == "ok") nextPage('describe');
                    else {
                        DW.logError(res.message, txtarea.parent().parent());
                    }
                }
            });

            txtarea.data('orig-val', txtarea.val());

            $('.upload-drop').css({
                position: 'absolute',
                top: txtarea.offset().top - $('.navbar').height(),
                left: txtarea.offset().left+2,
                width: txtarea.width()+2,
                height: txtarea.height()+2,
                'line-height': txtarea.height()+'px'
            });

            $('.submit').click(function(e) {
                if (txtarea.val() != txtarea.data('orig-val')) {
                    e.preventDefault();
                    var a = $(e.target);
                    if (e.target.nodeName.toLowerCase() != "a") a = a.parents('a');
                    uploadData(a.attr('href'));
                }
            });

        });
    </script>

    <div class="row">
        <div class="span7">
            <h2 style="margin-bottom:10px">{% trans "Upload Your Data" %}</h2>

             <form class="well upload-form">
                <textarea id="upload-data-text" style="resize:none" placeholder="{% trans "Copy &amp; paste your data here" %}">{{ chartData }}</textarea>

                <div id="upload-data" class="btn btn-primary pull-right">{% trans "Upload and continue" %} <i class="icon-chevron-right icon-white"></i></div>

                <div id="upload"></div>

            </form>


        </div>

        <div class="span5">
            <h3>{% trans "How it works.." %}</h3>
            <p>{% trans "We made getting data into Datawrapper as easy as possible. If you're working in Excel or OpenOffice, just select your data (including header row/column) and paste it in the following text field." %} <a href="/popups/uploading-data?popup=1" data-toggle="modal">{% trans "Learn more about how to upload your data" %}</a>.</p>

        </div>

        <div class="span4 inactive">

        </div>


    </div>


</div>
<script type="text/javascript" src="/static/vendor/ajaxupload/fileuploader.js"></script>
<link rel="stylesheet" type="text/css" href="/static/vendor/ajaxupload/fileuploader.css">
{% endblock %}